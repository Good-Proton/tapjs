{"version":3,"file":"clean-yaml-object.js","sourceRoot":"","sources":["../../src/clean-yaml-object.ts"],"names":[],"mappings":"AAAA,OAAO,KAAK,KAAK,MAAM,cAAc,CAAA;AACrC,OAAO,EAAE,mBAAmB,EAAE,MAAM,MAAM,CAAA;AAC1C,OAAO,EAAE,YAAY,EAAE,MAAM,SAAS,CAAA;AACtC,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,MAAM,UAAU,CAAA;AACzC,OAAO,EAAE,cAAc,EAAE,MAAM,uBAAuB,CAAA;AAGtD,MAAM,WAAW,GAAG,CAAC,IAAY,EAAE,EAAE;IACnC,IAAI,CAAC;QACH,OAAO,YAAY,CAAC,IAAI,EAAE,MAAM,CAAC,CAAA;IACnC,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACX,OAAM;IACR,CAAC;AACH,CAAC,CAAA;AAED,MAAM,MAAM,GAAG,CAAC,GAAyB,EAAE,GAAW,EAAE,EAAE,CACxD,MAAM,CAAC,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;AAEhD;;;;GAIG;AACH,MAAM,CAAC,MAAM,eAAe,GAAG,CAC7B,GAAyB,EACzB,OAAiB,IAAI,GAAG,EAAE,EAC1B,EAAE;IACF,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;IACb,MAAM,GAAG,GAAG,EAAE,GAAG,GAAG,EAAE,CAAA;IACtB,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;IACb,IAAI,MAAM,CAAC,GAAG,EAAE,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,IAAI,CAAC,EAAE,CAAC;QAC/C,MAAM,EAAE,GACN,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC;YACxB,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;YACzD,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,CAAA;QACrB,MAAM,CAAC,GAAG,KAAK,CAAC,UAAU,CAAC,EAAE,CAAC,CAAA;QAC9B,GAAG,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,CAAA;QACb,GAAG,CAAC,KAAK,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC,CAAA;IACnD,CAAC;IACD,IACE,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ;QAC7B,GAAG,CAAC,KAAK;QACT,CAAC,GAAG,CAAC,KAAK,CAAC,QAAQ,CAAC,IAAI,CAAC,EACzB,CAAC;QACD,GAAG,CAAC,KAAK,GAAG,GAAG,CAAC,KAAK,CAAC,OAAO,EAAE,GAAG,IAAI,CAAA;IACxC,CAAC;IAED,4DAA4D;IAC5D,IAAI,GAAG,CAAC,WAAW,IAAI,OAAO,GAAG,CAAC,WAAW,KAAK,QAAQ,EAAE,CAAC;QAC3D,GAAG,CAAC,WAAW,GAAG,eAAe,CAAC,GAAG,CAAC,WAAW,EAAE,IAAI,CAAC,CAAA;IAC1D,CAAC;IACD,oBAAoB;IAEpB,IACE,GAAG,CAAC,KAAK;QACT,OAAO,GAAG,CAAC,KAAK,KAAK,QAAQ;QAC7B,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,EACpB,CAAC;QACD,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,CAAC,CAAA;QACnB,MAAM,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,KAAK,CAAA;QAC7B,MAAM,EAAE,GAAG,cAAc,CAAC,GAAG,CAAC,KAAK,CAAC,CAAA;QACpC,MAAM,KAAK,GAAG,eAAe,CAAC,EAAE,EAAE,IAAI,CAAC,CAAA;QACvC,IAAI,OAAO,KAAK,SAAS;YAAE,KAAK,CAAC,OAAO,GAAG,OAAO,CAAA;QAClD,GAAG,CAAC,KAAK,GAAG,KAAK,CAAA;IACnB,CAAC;IACD,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC;QAC9B,MAAM,OAAO,GAAY,EAAE,CAAA;QAC3B,KAAK,MAAM,CAAC,IAAI,GAAG,CAAC,MAAM,EAAE,CAAC;YAC3B,IAAI,CAAC,CAAC,CAAC,IAAI,OAAO,CAAC,KAAK,QAAQ,EAAE,CAAC;gBACjC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAA;gBACX,MAAM,EAAE,OAAO,EAAE,GAAG,CAAC,CAAA;gBACrB,MAAM,EAAE,GAAG,cAAc,CAAC,CAAC,CAAC,CAAA;gBAC5B,MAAM,KAAK,GAAG,eAAe,CAAC,EAAE,EAAE,IAAI,CAAC,CAAA;gBACvC,IAAI,OAAO,KAAK,SAAS;oBAAE,KAAK,CAAC,OAAO,GAAG,OAAO,CAAA;gBAClD,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;YACrB,CAAC;iBAAM,CAAC;gBACN,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;YACjB,CAAC;QACH,CAAC;QACD,GAAG,CAAC,MAAM,GAAG,OAAO,CAAA;IACtB,CAAC;IAED,IACE,GAAG,CAAC,EAAE;QACN,GAAG,CAAC,EAAE,YAAY,KAAK,CAAC,YAAY;QACpC,GAAG,CAAC,EAAE,CAAC,QAAQ;QACf,GAAG,CAAC,EAAE,CAAC,gBAAgB;QACvB,GAAG,CAAC,EAAE,CAAC,UAAU;QACjB,CAAC,GAAG,CAAC,MAAM,EACX,CAAC;QACD,MAAM,IAAI,GAAG,GAAG,CAAC,EAAE,CAAC,gBAAgB,CAAA;QACpC,MAAM,OAAO,GAAG,WAAW,CAAC,IAAI,CAAC,CAAA;QACjC,IAAI,OAAO,EAAE,CAAC;YACZ,MAAM,KAAK,GAAG,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;YACjC,IAAI,GAAG,CAAC,EAAE,CAAC,UAAU,IAAI,KAAK,CAAC,MAAM,EAAE,CAAC;gBACtC,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,GAAG,CAAC,EAAE,CAAC,CAAC,CAAA;gBACpD,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,GAAG,CAAC,EAAE,KAAK,CAAC,MAAM,CAAC,CAAA;gBAC7D,MAAM,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,GAAG,CAAC,CAAC,CAAA;gBACzC,MAAM,KAAK,GACT,CACE,GAAG,CAAC,EAAE,CAAC,YAAY;oBACnB,IAAI;oBACJ,GAAG,CAAC,EAAE,CAAC,YAAY,IAAI,IAAI,CAAC,MAAM,CACnC,CAAC,CAAC;oBACD,CAAC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,YAAY,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC;oBAC7C,CAAC,CAAC,EAAE,CAAA;gBACN,MAAM,OAAO,GAAG,KAAK;qBAClB,KAAK,CAAC,SAAS,EAAE,GAAG,CAAC,EAAE,CAAC,UAAU,CAAC;qBACnC,MAAM,CAAC,KAAK,CAAC;qBACb,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC,CAAA;gBAClD,MAAM,MAAM,GAAG,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,CAAA;gBAC3C,IAAI,MAAM;oBAAE,GAAG,CAAC,MAAM,GAAG,MAAM,GAAG,IAAI,CAAA;YACxC,CAAC;QACH,CAAC;IACH,CAAC;IACD,IAAI,GAAG,CAAC,EAAE,IAAI,GAAG,CAAC,EAAE,YAAY,KAAK,CAAC,YAAY,EAAE,CAAC;QACnD,GAAG,CAAC,EAAE,GAAG,GAAG,CAAC,EAAE,CAAC,MAAM,EAAE,CAAA;IAC1B,CAAC;IAED,kCAAkC;IAClC,oDAAoD;IACpD,uDAAuD;IACvD,oDAAoD;IACpD,uCAAuC;IACvC,IACE,OAAO,IAAI,GAAG;QACd,QAAQ,IAAI,GAAG;QACf,GAAG,CAAC,KAAK,KAAK,GAAG,CAAC,MAAM;QACxB,CAAC,GAAG,CAAC,IAAI,EACT,CAAC;QACD,MAAM,CAAC,GAAG,GAAG,CAAC,KAAK,CAAA;QACnB,MAAM,CAAC,GAAG,GAAG,CAAC,MAAM,CAAA;QACpB,IAAI,OAAO,CAAC,KAAK,QAAQ,IAAI,OAAO,CAAC,KAAK,QAAQ;YAChD,GAAG,CAAC,IAAI,GAAG,mBAAmB,CAC5B,UAAU,EACV,QAAQ,EACR,CAAC,GAAG,IAAI,EACR,CAAC,GAAG,IAAI,CACT,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAA;aACnB,IACH,CAAC;YACD,CAAC;YACD,OAAO,CAAC,KAAK,QAAQ;YACrB,OAAO,CAAC,KAAK,QAAQ,EACrB,CAAC;YACD,MAAM,CAAC,GAAG,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAA;YACtB,IAAI,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;gBACb,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC,IAAI,CAAA;YACnB,CAAC;iBAAM,CAAC;gBACN,GAAG,CAAC,IAAI,GAAG,0BAA0B,CAAA;YACvC,CAAC;QACH,CAAC;aAAM,CAAC;YACN,2BAA2B;YAC3B,MAAM,EAAE,GAAG,MAAM,CAAC,CAAC,CAAC,CAAA;YACpB,MAAM,EAAE,GAAG,MAAM,CAAC,CAAC,CAAC,CAAA;YACpB,MAAM,EAAE,GAAG,CAAC,OAAO,CAAC,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,GAAG,IAAI,CAAA;YAClD,MAAM,EAAE,GAAG,CAAC,OAAO,CAAC,KAAK,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC,GAAG,IAAI,CAAA;YAClD,IAAI,EAAE,KAAK,EAAE,EAAE,CAAC;gBACd,GAAG,CAAC,IAAI,GAAG,mBAAmB,CAC5B,UAAU,EACV,QAAQ,EACR,EAAE,EACF,EAAE,CACH,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAA;YACxB,CAAC;QACH,CAAC;QACD,IAAI,GAAG,CAAC,IAAI,KAAK,4BAA4B,EAAE,CAAC;YAC9C,OAAO,GAAG,CAAC,IAAI,CAAA;QACjB,CAAC;QACD,IAAI,GAAG,CAAC,IAAI,EAAE,CAAC;YACb,OAAO,GAAG,CAAC,KAAK,CAAA;YAChB,OAAO,GAAG,CAAC,MAAM,CAAA;QACnB,CAAC;IACH,CAAC;IAED,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;QAC/C,IAAI,eAAe,CAAC,GAAG,EAAE,KAAK,CAAC,EAAE,CAAC;YAChC,OAAO,GAAG,CAAC,GAAG,CAAC,CAAA;QACjB,CAAC;IACH,CAAC;IAED,wDAAwD;IACxD,gDAAgD;IAChD,IAAI,OAAO,GAAG,CAAC,OAAO,KAAK,QAAQ;QAAE,OAAO,GAAG,CAAC,OAAO,CAAA;IAEvD,6BAA6B;IAC7B,IACE,GAAG,CAAC,IAAI,KAAK,IAAI;QACjB,OAAO,GAAG,CAAC,QAAQ,KAAK,QAAQ;QAChC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,EAC3B,CAAC;QACD,GAAG,CAAC,QAAQ,GAAG,eAAe,CAAA;IAChC,CAAC;IACD,+BAA+B;IAC/B,IAAI,GAAG,CAAC,KAAK,EAAE,CAAC;QACd,MAAM,EAAE,KAAK,EAAE,GAAG,KAAK,EAAE,GAAG,GAAG,CAAA;QAC/B,OAAO,EAAE,GAAG,KAAK,EAAE,KAAK,EAAE,CAAA;IAC5B,CAAC;IAED,OAAO,GAAG,CAAA;AACZ,CAAC,CAAA;AAED;;;;GAIG;AACH,MAAM,CAAC,MAAM,YAAY,GAAG,IAAI,GAAG,CAAC;IAClC,MAAM;IACN,MAAM;IACN,SAAS;IACT,IAAI;IACJ,MAAM;IACN,QAAQ;IACR,MAAM;IACN,MAAM;IACN,YAAY;IACZ,UAAU;IACV,QAAQ;IACR,uEAAuE;IACvE,UAAU;IACV,UAAU;IACV,UAAU;IACV,mDAAmD;IACnD,4CAA4C;IAC5C,MAAM;IACN,YAAY;IACZ,MAAM;IACN,aAAa;IACb,KAAK;CACN,CAAC,CAAA;AAEF;;;GAGG;AACH,MAAM,CAAC,MAAM,aAAa,GAAG,IAAI,GAAG,CAAC;IACnC,IAAI;IACJ,OAAO;IACP,SAAS;IACT,OAAO;IAEP,mDAAmD;IACnD,4CAA4C;IAC5C,SAAS;IACT,gBAAgB;CACjB,CAAC,CAAA;AAEF;;;GAGG;AACH,MAAM,CAAC,MAAM,aAAa,GAAG;IAC3B,aAAa;IACb,YAAY;IACZ,qCAAqC;IACrC,eAAe;CAChB,CAAA;AAED,MAAM,eAAe,GAAG,CAAC,GAAW,EAAE,KAAU,EAAE,EAAE,CAClD,YAAY,CAAC,GAAG,CAAC,GAAG,CAAC;IACrB,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,CAAC,IAAI,OAAO,CAAC,KAAK,CAAC,CAAC;IAC1C,aAAa,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,CAAA;AAEtC,iEAAiE;AACjE,MAAM,OAAO,GAAG,CAAC,GAAQ,EAAa,EAAE;IACtC,IAAI,CAAC,GAAG,EAAE,CAAC;QACT,OAAO,IAAI,CAAA;IACb,CAAC;IACD,IAAI,OAAO,GAAG,KAAK,QAAQ,EAAE,CAAC;QAC5B,OAAO,KAAK,CAAA;IACd,CAAC;IACD,IAAI,KAAK,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC;QACvB,OAAO,GAAG,CAAC,MAAM,KAAK,CAAC,CAAA;IACzB,CAAC;IACD,KAAK,MAAM,CAAC,IAAI,GAAG,EAAE,CAAC;QACpB,OAAO,KAAK,CAAA;IACd,CAAC;IACD,OAAO,IAAI,CAAA;AACb,CAAC,CAAA","sourcesContent":["import * as stack from '@tapjs/stack'\r\nimport { createTwoFilesPatch } from 'diff'\r\nimport { readFileSync } from 'node:fs'\r\nimport { format, strict } from 'tcompare'\r\nimport { extraFromError } from './extra-from-error.js'\r\nimport { Extra } from './index.js'\r\n\r\nconst tryReadFile = (path: string) => {\r\n  try {\r\n    return readFileSync(path, 'utf8')\r\n  } catch (_) {\r\n    return\r\n  }\r\n}\r\n\r\nconst hasOwn = (obj: { [k: string]: any }, key: string) =>\r\n  Object.prototype.hasOwnProperty.call(obj, key)\r\n\r\n/**\r\n * Prepare an object for printing to YAML diagnostics.\r\n *\r\n * Looks up source, calculates diffs of actual/expected values, and so on.\r\n */\r\nexport const cleanYamlObject = (\r\n  obj: { [k: string]: any },\r\n  seen: Set<any> = new Set(),\r\n) => {\r\n  seen.add(obj)\r\n  const res = { ...obj }\r\n  seen.add(res)\r\n  if (hasOwn(res, 'stack') && !hasOwn(res, 'at')) {\r\n    const st =\r\n      Array.isArray(res.stack) ?\r\n        res.stack.map(s => String(s).trimEnd() + '\\n').join('')\r\n      : String(res.stack)\r\n    const p = stack.parseStack(st)\r\n    res.at = p[0]\r\n    res.stack = p.map(c => String(c) + '\\n').join('')\r\n  }\r\n  if (\r\n    typeof res.stack === 'string' &&\r\n    res.stack &&\r\n    !res.stack.endsWith('\\n')\r\n  ) {\r\n    res.stack = res.stack.trimEnd() + '\\n'\r\n  }\r\n\r\n  /* c8 ignore start - old pre-Error.cause custom decorator */\r\n  if (res.errorOrigin && typeof res.errorOrigin === 'object') {\r\n    res.errorOrigin = cleanYamlObject(res.errorOrigin, seen)\r\n  }\r\n  /* c8 ignore stop */\r\n\r\n  if (\r\n    res.cause &&\r\n    typeof res.cause === 'object' &&\r\n    !seen.has(res.cause)\r\n  ) {\r\n    seen.add(res.cause)\r\n    const { message } = res.cause\r\n    const ex = extraFromError(res.cause)\r\n    const clean = cleanYamlObject(ex, seen)\r\n    if (message !== undefined) clean.message = message\r\n    res.cause = clean\r\n  }\r\n  if (Array.isArray(res.errors)) {\r\n    const cleaned: Extra[] = []\r\n    for (const e of res.errors) {\r\n      if (!!e && typeof e === 'object') {\r\n        seen.add(e)\r\n        const { message } = e\r\n        const ex = extraFromError(e)\r\n        const clean = cleanYamlObject(ex, seen)\r\n        if (message !== undefined) clean.message = message\r\n        cleaned.push(clean)\r\n      } else {\r\n        cleaned.push(e)\r\n      }\r\n    }\r\n    res.errors = cleaned\r\n  }\r\n\r\n  if (\r\n    res.at &&\r\n    res.at instanceof stack.CallSiteLike &&\r\n    res.at.fileName &&\r\n    res.at.absoluteFileName &&\r\n    res.at.lineNumber &&\r\n    !res.source\r\n  ) {\r\n    const file = res.at.absoluteFileName\r\n    const content = tryReadFile(file)\r\n    if (content) {\r\n      const lines = content.split('\\n')\r\n      if (res.at.lineNumber <= lines.length) {\r\n        const startLine = Math.max(res.at.lineNumber - 3, 0)\r\n        const endLine = Math.min(res.at.lineNumber + 2, lines.length)\r\n        const line = lines[res.at.lineNumber - 1]\r\n        const caret =\r\n          (\r\n            res.at.columnNumber &&\r\n            line &&\r\n            res.at.columnNumber <= line.length\r\n          ) ?\r\n            ['-'.repeat(res.at.columnNumber - 1) + '^']\r\n          : []\r\n        const context = lines\r\n          .slice(startLine, res.at.lineNumber)\r\n          .concat(caret)\r\n          .concat(lines.slice(res.at.lineNumber, endLine))\r\n        const csplit = context.join('\\n').trimEnd()\r\n        if (csplit) res.source = csplit + '\\n'\r\n      }\r\n    }\r\n  }\r\n  if (res.at && res.at instanceof stack.CallSiteLike) {\r\n    res.at = res.at.toJSON()\r\n  }\r\n\r\n  // show a line by line string diff\r\n  // diff the yaml, to make it more humane, especially\r\n  // when strings or buffers are very large or multi-line\r\n  // the shipped compare methods will generally supply\r\n  // their own diff, which is much nicer.\r\n  if (\r\n    'found' in res &&\r\n    'wanted' in res &&\r\n    res.found !== res.wanted &&\r\n    !res.diff\r\n  ) {\r\n    const f = res.found\r\n    const w = res.wanted\r\n    if (typeof f === 'string' && typeof w === 'string')\r\n      res.diff = createTwoFilesPatch(\r\n        'expected',\r\n        'actual',\r\n        w + '\\n',\r\n        f + '\\n',\r\n      ).replace(/^=+\\n/, '')\r\n    else if (\r\n      f &&\r\n      w &&\r\n      typeof f === 'object' &&\r\n      typeof w === 'object'\r\n    ) {\r\n      const s = strict(f, w)\r\n      if (!s.match) {\r\n        res.diff = s.diff\r\n      } else {\r\n        res.note = 'object identities differ'\r\n      }\r\n    } else {\r\n      // some mixed stringly bits\r\n      const ff = format(f)\r\n      const fw = format(w)\r\n      const fs = (typeof f === 'string' ? f : ff) + '\\n'\r\n      const ws = (typeof w === 'string' ? w : fw) + '\\n'\r\n      if (fw !== ff) {\r\n        res.diff = createTwoFilesPatch(\r\n          'expected',\r\n          'actual',\r\n          ws,\r\n          fs,\r\n        ).replace(/^=+\\n/, '')\r\n      }\r\n    }\r\n    if (res.diff === '--- expected\\n+++ actual\\n') {\r\n      delete res.diff\r\n    }\r\n    if (res.diff) {\r\n      delete res.found\r\n      delete res.wanted\r\n    }\r\n  }\r\n\r\n  for (const [key, value] of Object.entries(res)) {\r\n    if (shouldDeleteKey(key, value)) {\r\n      delete res[key]\r\n    }\r\n  }\r\n\r\n  // if the 'message' is a string, then we print it on the\r\n  // test point, so no need to repeat in the diags\r\n  if (typeof res.message === 'string') delete res.message\r\n\r\n  // worker: remove inline code\r\n  if (\r\n    res.eval === true &&\r\n    typeof res.filename === 'string' &&\r\n    res.filename.includes('\\n')\r\n  ) {\r\n    res.filename = '<inline code>'\r\n  }\r\n  // always put cause at the end.\r\n  if (res.cause) {\r\n    const { cause, ...props } = res\r\n    return { ...props, cause }\r\n  }\r\n\r\n  return res\r\n}\r\n\r\n/**\r\n * Properties that are *always* removed from the diagnostics, either because\r\n * they are internal (eg, `time`), overly noisy (eg, `parent`), or captured\r\n * elsewhere in the TAP output (eg, `skip`).\r\n */\r\nexport const deleteAlways = new Set([\r\n  'todo',\r\n  'time',\r\n  'childId',\r\n  'cb',\r\n  'name',\r\n  'indent',\r\n  'skip',\r\n  'bail',\r\n  'diagnostic',\r\n  'buffered',\r\n  'parent',\r\n  // only relevant if activated, a failedTodo or failedSkip will be added\r\n  'failSkip',\r\n  'failTodo',\r\n  'failOnly',\r\n  // TODO: keys added by plugins, but referenced here\r\n  // How can this list be adjusted by plugins?\r\n  'grep',\r\n  'grepInvert',\r\n  'only',\r\n  'saveFixture',\r\n  'env',\r\n])\r\n\r\n/**\r\n * Fields on this list are removed from YAML diagnostics if they are empty\r\n * (ie, falsey, empty array, or object with no keys)\r\n */\r\nexport const deleteIfEmpty = new Set([\r\n  'at',\r\n  'stack',\r\n  'context',\r\n  'debug',\r\n\r\n  // TODO: keys added by plugins, but referenced here\r\n  // How can this list be adjusted by plugins?\r\n  'runOnly',\r\n  'compareOptions',\r\n])\r\n\r\n/**\r\n * Fields are removed from YAML diagnostics if they match any of these\r\n * patterns.\r\n */\r\nexport const deleteIfMatch = [\r\n  /^_?tapChild/,\r\n  /^tapStream/,\r\n  // TODO: create a @tapjs/mocha plugin\r\n  /^tapMochaTest/,\r\n]\r\n\r\nconst shouldDeleteKey = (key: string, value: any) =>\r\n  deleteAlways.has(key) ||\r\n  (deleteIfEmpty.has(key) && isEmpty(value)) ||\r\n  deleteIfMatch.some(r => r.test(key))\r\n\r\n// return true if object is empty, including inherited properties\r\nconst isEmpty = (obj: any): obj is {} => {\r\n  if (!obj) {\r\n    return true\r\n  }\r\n  if (typeof obj !== 'object') {\r\n    return false\r\n  }\r\n  if (Array.isArray(obj)) {\r\n    return obj.length === 0\r\n  }\r\n  for (const _ in obj) {\r\n    return false\r\n  }\r\n  return true\r\n}\r\n"]}